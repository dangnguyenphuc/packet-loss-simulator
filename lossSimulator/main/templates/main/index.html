{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Loss Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="{% static 'main/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
</head>
<body>
    <h1>Hello, {{ name }}!</h1>
        
    <div class="d-flex flex-column gap-3">
        <div class="row d-flex flex-md-row flex-column intro">
                <div class="col-md-3 col-12 d-flex title align-items-center justify-content-center">
                    <span>How to use</span>
                </div>
                <div class="col bg-light border">
                <pre>
1. (Optional) Set time to apply config -> If not, The config will just stop when you delete it
2. Select device IP you want to apply config
3. Choose option to apply:
    3.1 Default Config JSON:
            + Defined JSON config for different network configuration
            + Can edit option to apply your own config
    3.2 Defined Loss Strategies (based on Mr.Tien (tiend3) 's strategies):
            + Fix90: Fixed 90% packet loss rate
            + Dynamic: Loss rate varies over time (each ... second)
            + IncreaseOnly: Same as Dynamic but loss rate always increase</pre>
                </div>
            </div>
        
    {% if name ==  "Stranger" %}
        <h2>You don't have any permission, please call for help</h2>
    {% else %}
        <div class="row d-flex flex-row">
            <div class="col ip-selector">

                <div class="title"><span>IP Selector</span></div>
                
                <div class="row d-flex flex-row gap-3 p-2">
                    <div class="col d-flex align-items-center gap-3">
                        <label for="ipAddresses">Choose an IP:</label>
                        <select id="ipAddresses" name="ipAddresses">
                            <option value="{{ name }}" selected>{{ name }}</option>
                            {% for device in devices %}
                            <option value="{{ device }}">{{ device }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center">
                        <button type="button" id="fetchIPBtn">Reload</button>
                    </div>
    
                </div>
            </div>

            <div class="col ip-monitor">
                <div class="title"><span>Monitor</span></div>

                <div class="row d-flex justify-content-center align-items-center gap-3 p-2">
                    <ul id="activeShapeList" class="list-unstyled d-flex flex-column justify-content-center gap-3"></ul>
                </div>
            </div>
        </div>

        <div class="row d-flex flex-column timer-container p-2">
            <div class="title"><span>Timer</span></div>
            <div id="timer" class="d-flex align-items-center justify-content-center gap-3">
                <label>Time to apply config:</label>
                <input type="number" id="hours" min="0" value="0" style="width:60px">
                <span>:</span>
                <input type="number" id="minutes" min="0" max="59" value="0" style="width:60px">
                <span>:</span>
                <input type="number" id="seconds" min="0" max="59" value="0" style="width:60px">
            </div>
        </div>

        <div class="row d-flex flex-md-row flex-column config-container">
            
            <div class="col default-config-json d-flex flex-column align-items-center gap-3 p-2">
                <div class="title">
                    <span>Default Config JSON</span>
                </div>
    
                    <div class="config-row">
                        <label for="jsonFiles">Choose a config:</label>
                        <select id="jsonFiles" name="jsonFiles">
                            <option value="" selected>-- Select a config --</option>
                            {% for file in files %}
                            <option value="{{ file }}">{{ file|cut:".json" }}</option>
                            {% endfor %}
                        </select>
                    </div>
    
                    <div id="editor">
                        <form id="jsonForm" method="post">
    
                            {% csrf_token %}
                            <textarea id="json-editor" name="json_data">{{ json_content }}</textarea>
                            <br>
    
                            <br>
                            <button type="submit" id="applyBtn">Apply</button>
                            <button type="button" id="deleteBtn">Delete</button>
                        </form>
                    </div>
            </div>
    
            <div class="col defined-loss-strategy d-flex flex-column align-items-center gap-3 p-2">
                <div class="title">Defined Loss Strategies</div>
            </div>
        </div>
    </div>
    {% endif %}

</body>

<script type="module">
    import { 
        fetchJson, 
        applyConfig, 
        postShape, 
        deleteShape, 
        convertTimerToMs,
        fetchIp,
        getShape,
        MONITORING_INTERVAL
    } from "{% static 'main/script.js' %}";
    
    // select DOM Objects
    const editorContainer = document.getElementById("editor");
    const editor =  CodeMirror.fromTextArea(document.getElementById("json-editor"), {
                        mode: "application/json",
                        theme: "dracula",
                        lineNumbers: true,
                    });
    const selectEl = document.getElementById("jsonFiles");
    const form = document.getElementById('jsonForm');
    const deleteBtn = document.getElementById("deleteBtn");
    const applyBtn = document.getElementById("applyBtn");
    const fetchIpBtn = document.getElementById("fetchIPBtn");
    const hour = document.getElementById("hours");
    const minute = document.getElementById("minutes");
    const second = document.getElementById("seconds");
    const activeShapeList = document.getElementById("activeShapeList");
    const ipSelector = document.getElementById("ipAddresses");
    let countDownInterval = null;

    // functions
    function setTimerValue(value)
    {
        const totalSeconds = Math.floor(value/1000);
        const s = totalSeconds % 60;
        second.value = s;
        const m = Math.floor((totalSeconds % 3600) / 60);
        if (m != minute.value)
        {
            minute.value = m;
            const h = Math.floor(totalSeconds / 3600);
            if (h != hour.value)
            {
                hour.value = h;
            }
        }
    }

    function resetTimer()
    {
        if (countDownInterval) clearInterval(countDownInterval);
        countDownInterval = null;
        hour.value = 0;
        minute.value = 0;
        second.value = 0;
    }

    function countDown(timeLeft)
    {
        if (countDownInterval) clearInterval(countDownInterval);

        countDownInterval = setInterval(() => {
            timeLeft -= 1000;

            setTimerValue(timeLeft);

            if (timeLeft <= 0) {
                resetTimer();
                isAppliedConf(false);
                alert("[TIMER] DELETED CONFIG");
            }
        }, 1000);
    }

    function isAppliedConf(val)
    {
        if (val)
        {
            applyBtn.textContent = "Applied"
            applyBtn.style.backgroundColor = "green";
            applyBtn.style.color = "white";    
            return;
        }

        applyBtn.textContent = "Apply"
        applyBtn.style.backgroundColor = "buttonface";
        applyBtn.style.color = "buttontext";

    }

    async function getActiveShape() {
        try {
            const res = (await getShape()).data;
            activeShapeList.innerHTML = "";
            res.forEach(data => {
                const isActive = data.active;
                const li = document.createElement("li");
                li.className = (isActive ? "bg-success" : "bg-danger") + " text-white"
                li.textContent = data.ip + (isActive ? "(active)" : "(inactive)");
                activeShapeList.appendChild(li);
            })
        }
        finally {
            return;
        }
    }
    // end functions

    // first load 
    editorContainer.style.display = "none";
    getActiveShape();
    setInterval(getActiveShape, MONITORING_INTERVAL);



    // on change option value
    selectEl.addEventListener("change", async (event) => {
        const selectedValue = event.target.value;
        if (!selectedValue || selectedValue.length <= 0)
        {
            // if selectedValue is "" or null -> display none
            editorContainer.style.display = "none";
            return;
        }
        editorContainer.style.display = "block";
        try{
            const data = await fetchJson(selectedValue);
            try {
                editor.setValue(JSON.stringify(data.data.content, null, 2));
            }
            catch (err)
            {
                editor.setValue(JSON.stringify(data.data, null, 2));
            }

        }
        catch (err)
        {
            editor.setValue("// " + err);
        }
    });

    // form on submit
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        let jsonData = {};
        try 
        {
            jsonData.data = JSON.parse(editor.getValue());
            jsonData.ip = ipSelector.value;
        } catch (err) 
        {
            alert('Invalid JSON: ' + err.message);
            return;
        }
        finally
        {
            const h = parseInt(hour.value, 0);
            const m = parseInt(minute.value, 0);
            const s = parseInt(second.value, 0);
            
            const timerValue = convertTimerToMs(h,m,s);
            
            // if timer is set
            if (timerValue > 0)
            {
                try {
                    await applyConfig(jsonData, timerValue);
                    isAppliedConf(true)
                    countDown(timerValue);
                }
                catch (e)
                {
                    alert("Error " + e);
                }
                return;
            }
            
            // else just applied without time-limit
            try 
            {
                const res = await postShape(jsonData);
                alert("[POST] success")
                isAppliedConf(true);
            }
            catch (err)
            {
                alert(err)
                isAppliedConf(false);
            }
            
        }
    });

    // delete btn on click
    deleteBtn.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this config?")) return;

        try 
        {
            const res = await deleteShape({
                "ip": ipSelector.value
            });
            if (!res.ok) throw new Error(res.status);
            alert("Deleted successfully!");
            isAppliedConf(false);
            resetTimer();
        } 
        catch (err) 
        {
            console.error(err);
            alert("Error deleting config with status: " + err);
        }
    });

    // reload ip btn on click handler
    fetchIpBtn.addEventListener("click", async () => {
        ipSelector.disabled = true;
        try{
            const devices = (await fetchIp()).data;
            // clear existing options
            ipSelector.innerHTML = `<option value="{{ name }}" selected>{{ name }}</option>`;
            devices.forEach(device => {
                const opt = document.createElement("option");
                opt.value = device;
                opt.textContent = device;
                ipSelector.appendChild(opt);
            });
        }
        catch (err)
        {
            alert("[GET] Ips error")
        }
        finally
        {
            ipSelector.disabled=false;
        }
    });


</script>
</html>